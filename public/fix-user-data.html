<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix User Data - Emergency Fix</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div class="container">
        <div class="auth-card">
            <h1>üö® EMERGENCY USER DATA FIX</h1>
            <p class="subtitle">This will force create user documents in Firestore</p>
            
            <div id="logs" style="background: #000; color: #0f0; padding: 15px; border-radius: 5px; font-family: monospace; height: 300px; overflow-y: auto; margin: 20px 0;"></div>
            
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" value="admin2006@gmail.com">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter password">
            </div>
            
            <div class="button-group">
                <button id="createAdminBtn" class="btn btn-danger">1. Create Admin Entry</button>
                <button id="registerBtn" class="btn btn-primary">2. Register User</button>
                <button id="loginBtn" class="btn btn-success">3. Login User</button>
                <button id="forceCreateBtn" class="btn btn-warning">4. FORCE Create User Doc</button>
            </div>
            
            <div style="margin-top: 20px;">
                <button id="checkBtn" class="btn btn-secondary">Check Current Status</button>
                <a href="admin/dashboard.html" class="btn btn-primary">Go to Dashboard</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './js/firebase.js';
        import { createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, doc, setDoc, getDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const logsDiv = document.getElementById('logs');
        
        function log(message) {
            console.log(message);
            logsDiv.innerHTML += message + '\n';
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        log('=== EMERGENCY USER DATA FIX TOOL ===');
        log('Ready to fix user data issues...');
        
        // Monitor auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                log(`‚úÖ User authenticated: ${user.email} (${user.uid})`);
            } else {
                log('‚ùå No user authenticated');
            }
        });
        
        // 1. Create admin entry
        document.getElementById('createAdminBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            
            try {
                log(`Creating admin entry for: ${email}`);
                
                const adminRef = doc(collection(db, 'admins'));
                await setDoc(adminRef, { email: email });
                
                log(`‚úÖ Admin entry created successfully`);
            } catch (error) {
                log(`‚ùå Error creating admin: ${error.message}`);
            }
        });
        
        // 2. Register user
        document.getElementById('registerBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                log(`Registering user: ${email}`);
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                log(`‚úÖ User registered in Firebase Auth: ${user.uid}`);
                
                // Now create user document
                await createUserDocument(user, email);
                
            } catch (error) {
                log(`‚ùå Registration error: ${error.message}`);
            }
        });
        
        // 3. Login user
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                log(`Logging in user: ${email}`);
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                log(`‚úÖ User logged in: ${user.uid}`);
                
                // Now create user document
                await createUserDocument(user, email);
                
            } catch (error) {
                log(`‚ùå Login error: ${error.message}`);
            }
        });
        
        // 4. Force create user document
        document.getElementById('forceCreateBtn').addEventListener('click', async () => {
            const user = auth.currentUser;
            
            if (!user) {
                log('‚ùå No user logged in. Please login first.');
                return;
            }
            
            await createUserDocument(user, user.email);
        });
        
        // Check current status
        document.getElementById('checkBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            
            log('=== CHECKING CURRENT STATUS ===');
            
            // Check if admin exists
            try {
                const adminsRef = collection(db, 'admins');
                const adminQuery = query(adminsRef, where('email', '==', email));
                const adminSnapshot = await getDocs(adminQuery);
                log(`Admin in 'admins' collection: ${!adminSnapshot.empty ? '‚úÖ YES' : '‚ùå NO'}`);
            } catch (error) {
                log(`‚ùå Error checking admin: ${error.message}`);
            }
            
            // Check current user
            const user = auth.currentUser;
            if (user) {
                log(`Current user: ${user.email} (${user.uid})`);
                
                // Check if user document exists
                try {
                    const userRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        log(`‚úÖ User document exists in Firestore`);
                        log(`   Role: ${userData.role}`);
                        log(`   Email: ${userData.email}`);
                        log(`   Name: ${userData.name}`);
                    } else {
                        log(`‚ùå User document NOT found in Firestore`);
                    }
                } catch (error) {
                    log(`‚ùå Error checking user document: ${error.message}`);
                }
            } else {
                log('‚ùå No user currently logged in');
            }
        });
        
        // Function to create user document
        async function createUserDocument(user, email) {
            try {
                log(`Creating user document for: ${user.uid}`);
                
                // Check if admin
                const adminsRef = collection(db, 'admins');
                const adminQuery = query(adminsRef, where('email', '==', email));
                const adminSnapshot = await getDocs(adminQuery);
                const isAdmin = !adminSnapshot.empty;
                const role = isAdmin ? 'admin' : 'participant';
                
                log(`User role determined: ${role}`);
                
                // Create user document
                const userRef = doc(db, 'users', user.uid);
                const userData = {
                    uid: user.uid,
                    email: email,
                    name: email.split('@')[0],
                    role: role,
                    createdAt: serverTimestamp(),
                    lastLoginAt: serverTimestamp(),
                    loginCount: 1,
                    status: 'active',
                    updatedAt: serverTimestamp()
                };
                
                log(`Writing user document to Firestore...`);
                await setDoc(userRef, userData);
                
                log(`‚úÖ User document created successfully!`);
                
                // Store in session
                sessionStorage.setItem('user', JSON.stringify({
                    uid: user.uid,
                    email: email,
                    name: email.split('@')[0],
                    role: role
                }));
                
                log(`‚úÖ User info stored in session storage`);
                
                // Verify it was created
                const verifyDoc = await getDoc(userRef);
                if (verifyDoc.exists()) {
                    log(`‚úÖ VERIFICATION: User document exists in Firestore`);
                    const data = verifyDoc.data();
                    log(`   Data: ${JSON.stringify(data, null, 2)}`);
                } else {
                    log(`‚ùå VERIFICATION FAILED: User document not found`);
                }
                
            } catch (error) {
                log(`‚ùå Error creating user document: ${error.message}`);
                log(`   Error details: ${JSON.stringify(error, null, 2)}`);
            }
        }
    </script>
</body>
</html>