<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistics - Blind-Venture Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg-primary: #050507; --bg-card: rgba(12, 12, 18, 0.95); --bg-elevated: #0f0f14; --border-color: rgba(255, 255, 255, 0.06); --text-primary: #ffffff; --text-secondary: #a1a1aa; --text-muted: #52525b; --accent: #3B82F6; --accent-glow: rgba(59, 130, 246, 0.25); --success: #10b981; --error: #ef4444; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-secondary); min-height: 100vh; }
        .bg-grid { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-image: linear-gradient(rgba(59, 130, 246, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(59, 130, 246, 0.03) 1px, transparent 1px); background-size: 60px 60px; pointer-events: none; }
        .gradient-orb { position: fixed; border-radius: 50%; filter: blur(80px); opacity: 0.4; pointer-events: none; }
        .orb-1 { width: 500px; height: 500px; background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%); top: -200px; right: -150px; }
        .navbar { position: fixed; top: 0; left: 0; right: 0; height: 72px; background: rgba(5, 5, 7, 0.9); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 48px; z-index: 100; backdrop-filter: blur(12px); }
        .navbar-brand { font-size: 1.375rem; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 12px; text-decoration: none; }
        .brand-icon { width: 36px; height: 36px; background: linear-gradient(135deg, #ffffff 0%, var(--accent) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.125rem; }
        .navbar-actions { display: flex; gap: 12px; }
        .btn-back { background: var(--bg-elevated); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 10px 20px; border-radius: 10px; font-size: 0.875rem; font-weight: 500; text-decoration: none; transition: all 0.2s ease; }
        .btn-back:hover { border-color: var(--accent); color: var(--accent); }
        .btn-logout { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 10px 20px; border-radius: 10px; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
        .btn-logout:hover { border-color: var(--error); color: var(--error); }
        .main-content { position: relative; z-index: 1; max-width: 1100px; margin: 0 auto; padding: 120px 32px 60px; }
        .page-header { margin-bottom: 32px; }
        .page-title { font-size: 2.25rem; font-weight: 800; color: var(--text-primary); letter-spacing: -0.03em; }
        .page-title span { background: linear-gradient(135deg, var(--accent) 0%, #60a5fa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
</style>
</head>
<body>
    <div class="bg-grid"></div>
    <div class="gradient-orb orb-1"></div>

    <style>
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; text-align: center; transition: all 0.2s ease; }
        .stat-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .stat-card h3 { font-size: 0.6875rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 12px; }
        .stat-value { font-size: 2rem; font-weight: 800; color: #ffffff; }
        
        .section-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px; padding: 28px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
        .section-title { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); }
        .tabs { display: flex; gap: 8px; }
        .tab-btn { padding: 10px 20px; border: 1px solid var(--border-color); background: var(--bg-elevated); color: var(--text-secondary); border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.875rem; transition: all 0.2s ease; }
        .tab-btn:hover { border-color: var(--accent); color: var(--accent); }
        .tab-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .room-card { background: var(--bg-elevated); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; margin-bottom: 20px; border-left: 4px solid var(--accent); }
        .room-card.completed { border-left-color: var(--success); }
        .room-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
        .room-header h3 { color: var(--text-primary); font-size: 1.125rem; }
        .status-badge { padding: 6px 14px; border-radius: 100px; font-size: 0.75rem; font-weight: 600; }
        .status-active { background: rgba(59, 130, 246, 0.15); color: var(--accent); }
        .status-completed { background: rgba(16, 185, 129, 0.15); color: #34d399; }
        .room-meta { color: var(--text-muted); font-size: 0.875rem; margin-bottom: 20px; }
        .room-code { font-family: monospace; background: rgba(59, 130, 246, 0.1); color: var(--accent); padding: 2px 8px; border-radius: 4px; }
        
        .winners-podium { display: flex; justify-content: center; align-items: flex-end; gap: 16px; margin: 20px 0; }
        .winner-card { text-align: center; padding: 16px; border-radius: 12px; min-width: 100px; }
        .winner-card.gold { background: linear-gradient(135deg, #ffd700, #ffec8b); order: 2; }
        .winner-card.silver { background: linear-gradient(135deg, #c0c0c0, #e8e8e8); order: 1; }
        .winner-card.bronze { background: linear-gradient(135deg, #cd7f32, #daa06d); order: 3; }
        .winner-rank { font-size: 1.5rem; margin-bottom: 4px; }
        .winner-name { font-weight: 700; color: #333; font-size: 0.8125rem; }
        .winner-score { font-size: 0.6875rem; color: #555; }
        
        .room-actions { display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; border: none; border-radius: 10px; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; text-decoration: none; }
        .btn-primary { background: linear-gradient(135deg, var(--accent) 0%, #2563eb 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-danger { background: transparent; border: 1px solid var(--error); color: var(--error); }
        .btn-danger:hover { background: var(--error); color: white; }
        
        details summary { cursor: pointer; color: var(--accent); font-weight: 600; font-size: 0.875rem; margin-top: 16px; }
        .competitors-list { max-height: 200px; overflow-y: auto; margin-top: 12px; background: var(--bg-primary); border-radius: 8px; padding: 8px; }
        .competitor-item { display: flex; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid var(--border-color); }
        .competitor-item:last-child { border-bottom: none; }
        .participant-status { padding: 2px 8px; border-radius: 100px; font-size: 0.6875rem; font-weight: 600; }
        .status-waiting { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }
        .status-qualified { background: rgba(16, 185, 129, 0.15); color: #34d399; }
        .status-eliminated { background: rgba(239, 68, 68, 0.15); color: #f87171; }
        
        .empty-state { text-align: center; padding: 60px; color: var(--text-muted); }
        
        @media (max-width: 900px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .navbar { padding: 0 20px; } .main-content { padding: 100px 16px 40px; } }
        @media (max-width: 540px) { .stats-grid { grid-template-columns: 1fr; } .winners-podium { gap: 8px; } .winner-card { min-width: 80px; padding: 12px; } }
    </style>

    <nav class="navbar">
        <a href="../index.html" class="navbar-brand"><div class="brand-icon">‚å®</div>Blind-Venture</a>
        <div class="navbar-actions">
            <a href="dashboard.html" class="btn-back">‚Üê Dashboard</a>
            <button onclick="handleLogout()" class="btn-logout">Logout</button>
        </div>
    </nav>

    <div class="main-content">
        <div class="page-header"><h1 class="page-title">Competition <span>Statistics</span></h1></div>

        <div class="stats-grid">
            <div class="stat-card"><h3>Active Rooms</h3><p class="stat-value" id="activeRooms">-</p></div>
            <div class="stat-card"><h3>Completed</h3><p class="stat-value" id="completedRooms">-</p></div>
            <div class="stat-card"><h3>Participants</h3><p class="stat-value" id="totalParticipants">-</p></div>
            <div class="stat-card"><h3>Avg WPM</h3><p class="stat-value" id="avgWPM">-</p></div>
            <div class="stat-card"><h3>Avg Accuracy</h3><p class="stat-value" id="avgAccuracy">-</p></div>
        </div>

        <div class="section-card">
            <div class="section-header">
                <h2 class="section-title">üè† Rooms</h2>
                <div class="tabs">
                    <button class="tab-btn active" id="activeTab">Active</button>
                    <button class="tab-btn" id="completedTab">Completed</button>
                </div>
            </div>
            <div id="activeRoomsList"></div>
            <div id="completedRoomsList" style="display: none;"></div>
        </div>
    </div>

    <script type="module">
        import { getCurrentUser, logoutUser } from '../js/auth.js';
        import { db } from '../js/firebase.js';
        import { collection, getDocs, query, where, doc, deleteDoc, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const user = getCurrentUser();
        if (!user) { window.location.href = '../login.html'; }
        else if (user.role !== 'admin') { window.location.href = '../join-room.html'; }
        
        window.handleLogout = function() { logoutUser(); };
        
        document.getElementById('activeTab').addEventListener('click', function() { this.classList.add('active'); document.getElementById('completedTab').classList.remove('active'); document.getElementById('activeRoomsList').style.display = 'block'; document.getElementById('completedRoomsList').style.display = 'none'; });
        document.getElementById('completedTab').addEventListener('click', function() { this.classList.add('active'); document.getElementById('activeTab').classList.remove('active'); document.getElementById('activeRoomsList').style.display = 'none'; document.getElementById('completedRoomsList').style.display = 'block'; });
        
        async function deleteRoomData(roomId) {
            try {
                const resultsQuery = query(collection(db, 'results'), where('roomId', '==', roomId));
                const resultsSnap = await getDocs(resultsQuery);
                const batch1 = writeBatch(db);
                let resultCount = 0;
                resultsSnap.forEach(d => { batch1.delete(d.ref); resultCount++; });
                if (resultCount > 0) await batch1.commit();
                const participantsQuery = query(collection(db, 'participants'), where('roomId', '==', roomId));
                const participantsSnap = await getDocs(participantsQuery);
                const batch2 = writeBatch(db);
                let participantCount = 0;
                participantsSnap.forEach(d => { batch2.delete(d.ref); participantCount++; });
                if (participantCount > 0) await batch2.commit();
                await deleteDoc(doc(db, 'roomConfig', roomId));
                await deleteDoc(doc(db, 'rooms', roomId));
                return { success: true, results: resultCount, participants: participantCount };
            } catch (error) { return { success: false, error: error.message }; }
        }
        
        window.handleDeleteRoom = async function(roomId, roomName) {
            if (!confirm('‚ö†Ô∏è DELETE ROOM "' + roomName + '"?\n\nThis action CANNOT be undone!')) return;
            const result = await deleteRoomData(roomId);
            if (result.success) { alert('‚úÖ Room deleted!'); loadStats(); }
            else alert('Failed: ' + result.error);
        };
        
        async function loadStats() {
            try {
                const roomsSnap = await getDocs(collection(db, 'rooms'));
                const participantsSnap = await getDocs(collection(db, 'participants'));
                const resultsSnap = await getDocs(collection(db, 'results'));
                let activeCount = 0, completedCount = 0;
                const activeRooms = [], completedRooms = [];
                roomsSnap.forEach(d => { const data = { id: d.id, ...d.data() }; const status = data.status || data.roundStatus || 'waiting'; if (status === 'completed') { completedCount++; completedRooms.push(data); } else { activeCount++; activeRooms.push(data); } });
                let totalWPM = 0, totalAcc = 0, resultCount = 0;
                resultsSnap.forEach(d => { const data = d.data(); totalWPM += data.wpm || 0; totalAcc += data.accuracy || 0; resultCount++; });
                document.getElementById('activeRooms').textContent = activeCount;
                document.getElementById('completedRooms').textContent = completedCount;
                document.getElementById('totalParticipants').textContent = participantsSnap.size;
                document.getElementById('avgWPM').textContent = resultCount > 0 ? (totalWPM / resultCount).toFixed(1) : '-';
                document.getElementById('avgAccuracy').textContent = resultCount > 0 ? (totalAcc / resultCount).toFixed(1) + '%' : '-';
                await renderRooms(activeRooms, 'activeRoomsList', false);
                await renderRooms(completedRooms, 'completedRoomsList', true);
            } catch (error) { console.error('Error:', error); }
        }
        
        async function renderRooms(rooms, containerId, isCompleted) {
            const container = document.getElementById(containerId);
            if (rooms.length === 0) { container.innerHTML = '<div class="empty-state">No rooms found</div>'; return; }
            let html = '';
            for (const room of rooms) {
                const participantsQuery = query(collection(db, 'participants'), where('roomId', '==', room.id));
                const participantsSnap = await getDocs(participantsQuery);
                const participants = []; participantsSnap.forEach(d => participants.push({ id: d.id, ...d.data() }));
                const resultsQuery = query(collection(db, 'results'), where('roomId', '==', room.id));
                const resultsSnap = await getDocs(resultsQuery);
                const results = []; resultsSnap.forEach(d => results.push({ id: d.id, ...d.data() }));
                const round3Results = results.filter(r => r.round === 3);
                const latestResults = round3Results.length > 0 ? round3Results : results;
                latestResults.sort((a, b) => (b.finalScore || 0) - (a.finalScore || 0));
                const top3 = latestResults.slice(0, 3);
                const nameMap = {};
                results.forEach(r => { if (r.userName && r.userId) nameMap[r.userId] = r.userName; });
                participants.forEach(p => { if (!nameMap[p.id] && p.name) nameMap[p.id] = p.name; });
                const roomNameEscaped = (room.roomName || 'Untitled Room').replace(/'/g, "\\'");
                html += '<div class="room-card ' + (isCompleted ? 'completed' : '') + '">';
                html += '<div class="room-header"><h3>' + (room.roomName || 'Untitled Room') + '</h3><span class="status-badge ' + (isCompleted ? 'status-completed' : 'status-active') + '">' + (isCompleted ? 'Completed' : (room.status || 'Active')) + '</span></div>';
                html += '<p class="room-meta">Code: <span class="room-code">' + room.roomCode + '</span> | Participants: ' + participants.length + '</p>';
                if (top3.length > 0) {
                    html += '<div class="winners-podium">';
                    if (top3.length > 1) html += '<div class="winner-card silver"><div class="winner-rank">ü•à</div><div class="winner-name">' + (nameMap[top3[1].userId] || 'Unknown') + '</div><div class="winner-score">' + (top3[1].finalScore || 0).toFixed(1) + ' pts</div></div>';
                    html += '<div class="winner-card gold"><div class="winner-rank">ü•á</div><div class="winner-name">' + (nameMap[top3[0].userId] || 'Unknown') + '</div><div class="winner-score">' + (top3[0].finalScore || 0).toFixed(1) + ' pts</div></div>';
                    if (top3.length > 2) html += '<div class="winner-card bronze"><div class="winner-rank">ü•â</div><div class="winner-name">' + (nameMap[top3[2].userId] || 'Unknown') + '</div><div class="winner-score">' + (top3[2].finalScore || 0).toFixed(1) + ' pts</div></div>';
                    html += '</div>';
                } else html += '<p style="color:var(--text-muted);">No results yet</p>';
                html += '<details><summary>View All Competitors (' + participants.length + ')</summary><div class="competitors-list">';
                participants.forEach(p => { html += '<div class="competitor-item"><span style="color:var(--text-primary);">' + p.name + '</span><span class="participant-status status-' + p.status + '">' + p.status + '</span></div>'; });
                html += '</div></details>';
                html += '<div class="room-actions"><a href="room-control.html?roomId=' + room.id + '" class="btn btn-primary">View Details</a>';
                if (isCompleted) html += '<button class="btn btn-danger" onclick="handleDeleteRoom(\'' + room.id + '\', \'' + roomNameEscaped + '\')">üóëÔ∏è Delete</button>';
                html += '</div></div>';
            }
            container.innerHTML = html;
        }
        loadStats();
        setInterval(loadStats, 30000);
    </script>
</body>
</html>
